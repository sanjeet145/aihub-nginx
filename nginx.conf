worker_processes auto;

events {
    worker_connections 1024;
}

http {
    upstream auth_service {
        server  aihub-authentication.onrender.com; 
    }

    # upstream model_service {
    #     server something.com; 
    # }
    log_format custom '$remote_addr - $host - "$request" - $status '
                  '"$http_user_agent" - "Auth: $http_authorization"';

    access_log /dev/stdout custom;        

    server {
      listen 80; 


        location /auth/ {
            proxy_pass https://aihub-authentication.onrender.com/api/;
            proxy_ssl_server_name on;
            proxy_ssl_verify off; 
            proxy_redirect off;

            # proxy_set_header 'Access-Control-Allow-Origin' '*' ;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Accept' always;

            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' '*';
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Accept';
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Length' 0;
                add_header 'Content-Type' 'text/plain; charset=UTF-8';
                return 204;
            }
        }



        # Route for Model service
       location /model/maternalrisk/ {
            proxy_pass https://maternal-risk-model.onrender.com/;
            proxy_ssl_server_name on;
            proxy_ssl_verify off; 
            proxy_redirect off;
            # add_header 'Access-Control-Allow-Origin' '*' always;
             proxy_set_header Authorization $http_authorization;

    # add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Accept' always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;

            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Accept' always;
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Length' 0;
                add_header 'Content-Type' 'text/plain; charset=UTF-8';
                return 204;
                }
       }
    location /testing/ {

        if ($request_method = OPTIONS) {
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Accept' always;
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Length' 0;
            add_header 'Content-Type' 'text/plain; charset=UTF-8';
            return 204;
        }

        proxy_pass https://testing-4my0.onrender.com/;
        proxy_ssl_server_name on;
        proxy_ssl_verify off; 
        proxy_redirect off;
        
        # add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Accept' always;
    }
    }
}
